<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Venta</title>
  <meta name="theme-color" content="#111827" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #0f172a;
      color: #e5e7eb;
      font-family: 'Inter', system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    input, button {
      outline: none;
      touch-action: manipulation;
    }
    input:invalid {
      border-color: #ef4444;
    }
    .error {
      color: #f87171;
      font-size: 0.8rem;
      margin-top: 4px;
    }
    .glass {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
  </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4">
  <div class="w-full max-w-md glass shadow-xl rounded-2xl p-8 space-y-6">
    <h1 class="text-3xl font-bold text-center text-blue-400">Registro de Venta</h1>
    <p id="user-display" class="text-center text-gray-400">Ingresa tu código de vendedor para comenzar.</p>

    <div id="message" class="hidden p-3 rounded-md text-sm font-medium text-center"></div>

    <form id="sale-form" class="space-y-5" enctype="multipart/form-data" novalidate>
      <!-- Código de vendedor -->
      <div id="codigo-section">
        <label for="codigo" class="block text-sm font-medium mb-1">Código de Vendedor</label>
        <input
          type="text"
          id="codigo"
          required
          placeholder="Ej: AA11"
          class="block w-full rounded-md bg-[#1e293b] border border-transparent px-4 py-3 text-base focus:border-blue-500 transition duration-150 uppercase"
        />
        <p id="error-codigo" class="error hidden">Código inválido. Verifique su código de vendedor.</p>
        <p class="text-xs text-gray-500 mt-1">Cada vendedor tiene su código asignado.</p>
      </div>

      <!-- Nombre -->
      <div>
        <label for="nombre" class="block text-sm font-medium mb-1">Nombre del Titular</label>
        <input
          type="text"
          id="nombre"
          required
          pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$"
          placeholder="Ej: Pepe Grillo"
          class="block w-full rounded-md bg-[#1e293b] border border-transparent px-4 py-3 text-base focus:border-blue-500 transition duration-150"
        />
        <p id="error-nombre" class="error hidden">Solo se permiten letras y espacios.</p>
      </div>

      <!-- Importe -->
      <div>
        <label for="monto" class="block text-sm font-medium mb-1">Importe</label>
        <input
          type="text"
          id="monto"
          required
          inputmode="decimal"
          placeholder="Ej: 50,00"
          class="block w-full rounded-md bg-[#1e293b] border border-transparent px-4 py-3 text-base focus:border-blue-500 transition duration-150"
        />
        <p id="error-monto" class="error hidden">Ingrese un número válido. Use coma (,) para decimales.</p>
      </div>

      <!-- Comprobante -->
      <div>
        <label for="comprobante" class="block text-sm font-medium mb-1">Comprobante (imagen máx. 1 MB)</label>
        <input
          type="file"
          id="comprobante"
          required
          accept="image/*"
          class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-500 transition duration-150"
        />
        <p id="error-comprobante" class="error hidden">Debe adjuntar una imagen menor a 1 MB.</p>
      </div>

      <!-- Botón -->
      <button
        type="submit"
        id="submit-btn"
        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-3 rounded-md text-base transition duration-150 shadow-md hover:shadow-blue-500/30 active:scale-95"
      >
        Enviar Registro
      </button>
    </form>
  </div>

  <script>
    // Relación código → nombre de vendedor
    const vendedores = {
      EP01: "Easypay",
      NV01: "Nestor",
      SR22: "Suni",
      JR88: "Jeusmar"
    };

    const form = document.getElementById('sale-form');
    const messageBox = document.getElementById('message');
    const userDisplay = document.getElementById('user-display');
    const codigoInput = document.getElementById('codigo');
    const codigoSection = document.getElementById('codigo-section');

    // ✅ Webhook de Make
    const WEBHOOK_URL = "https://hook.us2.make.com/mxvvtwmv3ruqbo7ar8gs2suybjm8d22s";

    // Si ya hay un código guardado, bloqueamos el campo y mostramos el nombre
    window.addEventListener("load", () => {
      const savedCode = localStorage.getItem("codigoVendedor");
      if (savedCode && vendedores[savedCode]) {
        mostrarUsuario(vendedores[savedCode]);
        codigoSection.classList.add("hidden"); // ocultamos el campo
      } else {
        userDisplay.textContent = "Ingresa tu código de vendedor para comenzar.";
      }
    });

    // Validar código al escribir
    codigoInput.addEventListener("input", (e) => {
      const code = e.target.value.trim().toUpperCase();
      if (vendedores[code]) {
        localStorage.setItem("codigoVendedor", code);
        mostrarUsuario(vendedores[code]);
        codigoSection.classList.add("hidden");
      }
    });

    function mostrarUsuario(nombre) {
      userDisplay.innerHTML = `Bienvenido, <span class="text-blue-400 font-semibold">${nombre}</span>. Completa los datos y adjunta el comprobante.`;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const codigo = localStorage.getItem("codigoVendedor");
      const vendedorNombre = vendedores[codigo];
      if (!vendedorNombre) {
        document.getElementById('error-codigo').classList.remove('hidden');
        codigoSection.classList.remove('hidden');
        return;
      }

      const nombre = document.getElementById('nombre');
      const monto = document.getElementById('monto');
      const comprobante = document.getElementById('comprobante');

      let valid = true;

      const regexNombre = /^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$/;
      if (!regexNombre.test(nombre.value.trim())) {
        document.getElementById('error-nombre').classList.remove('hidden');
        valid = false;
      } else {
        document.getElementById('error-nombre').classList.add('hidden');
      }

      const regexMonto = /^\d+(,\d{1,2})?$/;
      if (!regexMonto.test(monto.value.trim())) {
        document.getElementById('error-monto').classList.remove('hidden');
        valid = false;
      } else {
        document.getElementById('error-monto').classList.add('hidden');
      }

      const file = comprobante.files[0];
      if (!file || file.size > 1024 * 1024) {
        document.getElementById('error-comprobante').classList.remove('hidden');
        valid = false;
      } else {
        document.getElementById('error-comprobante').classList.add('hidden');
      }

      if (!valid) return;

      // Fecha local
      const ahora = new Date();
      const pad = (n) => n.toString().padStart(2, '0');
      const fechaFormateada = `${pad(ahora.getDate())}/${pad(ahora.getMonth() + 1)}/${ahora.getFullYear()} ${pad(ahora.getHours())}:${pad(ahora.getMinutes())}`;

      // Datos a enviar
      const formData = new FormData();
      formData.append('vendedor', vendedorNombre);
      formData.append('nombre', nombre.value.trim());
      formData.append('monto', monto.value.trim());
      formData.append('fecha', fechaFormateada);
      formData.append('comprobante', file);

      try {
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          body: formData,
          mode: 'cors',
        });

        if (response.ok) {
          showMessage("✅ Registro enviado correctamente.", false);
          form.reset();
        } else {
          throw new Error("Error en el envío");
        }
      } catch {
        showMessage("❌ No se pudo enviar el registro. Intente nuevamente.", true);
      }
    });

    function showMessage(text, isError = false) {
      messageBox.textContent = text;
      messageBox.classList.remove('hidden', 'bg-red-600', 'bg-green-600');
      messageBox.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
    }
  </script>
</body>
</html>
